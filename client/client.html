<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
    <svg viewBox="0 0 1000 1000" xmlns="http://www.w3.org/2000/svg" stroke="black" >
      <image href="watch.png" height="647" width="647" />
      <rect width="1000" height="1000" stroke-width="0" fill="white" fill-opacity="0.5"/>
      <line x1="220" y1="312" x2="700" y2="250" />  <!-- x axis -->
      <line x1="393" y1="0" x2="527" y2="562" />  <!-- y axis -->
      <line x1="600" y1="200" x2="320" y2="362" />  <!-- z axis -->
      <text x="680" y="270" stroke="red">x</text>
      <text x="380" y="20" stroke="green">y</text>
      <text x="590" y="220" stroke="blue">z</text>
      <line id='x' x1="440" y1="281" x2="700" y2="250" stroke="red"/>  <!-- x component -->
      <line id='y' x1="460" y1="281" x2="0" y2="0" stroke="green"/>  <!-- y component -->
      <line id='z' x1="460" y1="281" x2="600" y2="200" stroke="blue"/>  <!-- z component -->
      <line id='v' x1="460" y1="281" x2="600" y2="200" stroke="black" stroke-width="3"/>  <!-- vector from origin with components x,y,z -->
    </svg>
    <script>
      const SERVER_URL = 'ws://192.168.1.30:8081' // phone
      //const SERVER_URL = 'ws://192.168.1.26:8081' // computer

      const xEl = document.getElementById('x')
      const yEl = document.getElementById('y')
      const zEl = document.getElementById('z')
      const vEl = document.getElementById('v')
      const originX = 460
      const originY = 281
      let x = 10
      let y = 10
      let z = 10
      //xEl.setAttribute('x2', originX + x / 10 * 89 * .9 + y / 10 * -36 * .9 + z * 7)
      //xEl.setAttribute('y2', originY + x / 10 * -12 * .9 + y / 10 * -149 * .9 + z * -.9)

      /*let a = 0
      setInterval(()=>{
        drawVector(Math.cos(a)*15, Math.sin(a)*15, Math.sin(a*1.5)*15)
        a += .02
      }, 20)*/

      drawVector(x,y,z)

      let connection
      openConnection()

      function openConnection() {
        connection = new WebSocket(SERVER_URL)
        connection.onopen = onConnectionOpen
        connection.onmessage = onConnectionMessage
        connection.onclose = onConnectionClose
        connection.onerror = onConnectionError
      }

      function onConnectionOpen() {
        console.log('desktop: connection open')
      }

      function onConnectionMessage(event) {
        //console.log(`desktop: connection message: ${event.data}`);
        event.data.arrayBuffer()
          .then(buffer => {
            //console.log(`len=${buffer.byteLength}`)
            const view = new Float32Array(buffer)
            //console.log(`${view[0]} ${view[1]} ${view[2]} ${view[3]}`)
            x = view[1]
            y = view[2]
            z = view[3]
            drawVector(x, y, z)

            // To test sending data from client to fitbit, copy z value into view[0] and return the array:
            view[0] = z
            connection.send(view)
          })
      }

      function onConnectionClose() {
        console.error(`desktop: connection closed: check server is running at ${SERVER_URL}`)
      }

      function onConnectionError() {
        console.error(`desktop: connection error: check server is running at ${SERVER_URL}`)
      }

      function drawVector(x,y,z) {
        let screenCoord

        screenCoord = toScreen(0, y, 0)
        xEl.setAttribute('x1', screenCoord.x)
        xEl.setAttribute('y1', screenCoord.y)

        screenCoord = toScreen(x, y, 0)
        xEl.setAttribute('x2', screenCoord.x)
        xEl.setAttribute('y2', screenCoord.y)

        yEl.setAttribute('x2', screenCoord.x)
        yEl.setAttribute('y2', screenCoord.y)

        zEl.setAttribute('x1', screenCoord.x)
        zEl.setAttribute('y1', screenCoord.y)

        screenCoord = toScreen(x, 0, 0)
        yEl.setAttribute('x1', screenCoord.x)
        yEl.setAttribute('y1', screenCoord.y)

        screenCoord = toScreen(x, y, 0)
        yEl.setAttribute('x2', screenCoord.x)
        yEl.setAttribute('y2', screenCoord.y)

        screenCoord = toScreen(x, y, z)
        zEl.setAttribute('x2', screenCoord.x)
        zEl.setAttribute('y2', screenCoord.y)

        vEl.setAttribute('x2', screenCoord.x)
        vEl.setAttribute('y2', screenCoord.y)
      }

      function toScreen(x,y,z) {
        // Convert 3D (x,y,z) to screen {x:x, y:y}.
        return({x:originX + x / 10 * 89 * .9 + y / 10 * -36 * .9 + z * 6, y:originY + x / 10 * -12 * .9 + y / 10 * -149 * .9 + z * -3.5})
      }

    </script>
  </body>
</html>
<!-- TODO 9 HTML: timeSeries view -->